<div class="container">
  <div class="row">
    <div class="col-md-5 text-center">
      <%= render "sidebar"%>
    </div>
    <div class="col-md-7">
      <% i=0 %>
      <% @user.appointments.each do |a|%>
      <% i+=1 %>
      <div class="scheduled col-xs-12">
        <div class="col-sm-5 scheduled-image img-responsive center-block">
          <div class="scheduled-dark"></div>
          <div class="scheduled-white">
            <%= image_tag("scheduled.png") %>
          </div>
          <div class="scheduled-text">
            <h5>SCHEDULED</h5>
            <h1><%= a.start.in_time_zone.strftime('%H:%M, %p') %></h1>
            <p><%= a.start.in_time_zone.strftime('%a') %>, </p>
            <h6><%= a.start.in_time_zone.strftime('%B%d, %Y') %></h6>
          </div>
        </div>
        <div class="col-sm-7">
          <div class="col-xs-12">
            <div class="clearfix flexmodify">
              <div class="info-mypic col-xs-3 pull-left">
                <%= image_tag(a.teacher.user.image) %>
              </div>
              <div class="info-eval col-xs-7">
                <p><%= a.teacher.user.first_name %>
                   <%= a.teacher.user.last_name %></p>
                  <div id="rateYo-<%= i %>"></div><span>(<%= Evaluation.where(evaluatable_type: "User", evaluated_id: a.teacher_id ).count %>)</span>
              </div>
              <div class=" col-xs-2 info-flag">
                <%= image_tag("flag.png") %>
              </div>
            </div>
            <div class="clearfix ratingnow gotocalss">
              <div class="conatiner-fluid">
                <% if Time.current.in_time_zone >= a.start.in_time_zone-10.minutes &&
                  Time.current.in_time_zone < a.end.in_time_zone %>
                  <form action="<%= a.appointment_url %>" target="_blank">
                    <button type="submit" name="gotoclass">GO TO CLASS</button>
                  </form>
                <% elsif Time.current.in_time_zone > a.end.in_time_zone %>
                  <% if a.evaluations.where(evaluatable_type: "User").blank? %>
                    <form action="<%= appointment_path(a.id) %>">
                      <button type="submit" name="rating">Rating Now</button>
                    </form>
                  <% else %>
                    <div class="rated">
                      <button id="rating-<%= a.id %>" name="rating">Rated</button>
                    </div>
                  <% end %>
                <% elsif Time.current.in_time_zone <= a.start.in_time_zone-10.minutes %>
                  <button type="submit" name="gotoclass">Please wait</button>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="pop-black-<%= a.id %>" class="pop-bg"></div>
      <div id="evaluation-white-<%= a.id %>" class="evaluation-white">
        <div class="evaluation col-xs-12">
          <div class="evaluation-button clearfix">
            <%= link_to "Back" ,classes_user_path ,:class=>"pull-left"%>
            <!--  <button class="pull-right" id ="eval-send">Send</button>
          </div> -->
            <div class="evaluation-block col-xs-10 col-xs-push-1">
              <div class="evaluation-me text-center">
                <%= image_tag(@user.image) %>
                <h4>Abner Chao</h4>
                <p>We hope you had a great lesson! please leave your teacher a review on their profile for other students to see.</p>
              </div>
              <div id="rateYo-<%= a.id %>" class="star-rating"></div>
              <div class="evaluation-comment">
                <h5>Comments</h5>
                <hr>
                <div class="user-comment">
                  <%= a.evaluations.where(evaluatable_type: "User").first.try(:comment) %>
                </div>
                <textarea id="comment"></textarea>
                <!-- <textarea id="comment" placeholder="You can ENTER your comment here!!
      What did you like about your teacher, and what could your teacher improve?"></textarea> -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <% end %>
    </div>
  </div>
</div>

<script src="https://apis.google.com/js/platform.js" async defer></script>
<script>
var i=0;
  $(document).ready(function () {

    <% @user.appointments.each do |a|%>

    i+=1;
    console.log(i);
    $('#pop-black-<%= a.id %>').hide();
    $('#evaluation-white-<%= a.id %>').hide();
    $('#rating-<%= a.id %>').click(function (e) {
      $('#pop-black-<%= a.id %>').fadeIn(1);
      $('#evaluation-white-<%= a.id %>').fadeIn(300);
    });
    $('#pop-black-<%= a.id %>').click(function (e) {
      $('#evaluation-white-<%= a.id %>').fadeOut(1);
      $('#pop-black-<%= a.id %>').fadeOut(1);
    });

    <% if a.evaluations.where(evaluatable_type: "User").blank? %>
    <% @raty = 0 %>
    <% else %>
    <% @raty = a.evaluations.where(evaluatable_type: "User").first.rating %>
    <% end %>

    $("#rateYo-<%= a.id %>").rateYo({starWidth: "40px", numStars: 5, fullStar: true, readOnly: true, rating: <%= @raty %>});

    $("#rateYo-"+i).rateYo({starWidth: "18px", numStars: 5, fullStar: true, readOnly: true, rating: <%= a.teacher.avg_rating %> });

    <% end %>

  });

</script>
