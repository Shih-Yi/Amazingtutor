<br/>
<%= @teacher.try(:youtube) %>

<br/>
<%= @teacher.user.email %>
<br/>
----------------
<div id='wrap'>
  <div id='external-events'>
    <h4>Draggable Class(drop to calendar to book)</h4>
    <% if @user_available_sections.trailed %>
        <div class='fc-event trailed'>trailed class</div>
        <% @user_available_sections.available_section -= 1 %>
    <% end %>
    <% (1..(@user_available_sections.available_section/2)).each do |i| %>
        <div class='fc-event nomal'>nomal class <%= i %></div>
    <% end %>
  </div>
  <div id='calendar' style="width:70%"></div>
</div>
<%= csrf_meta_tag %>
<script>
  $(document).ready(function () {

    $('#external-events .trailed').each(function () {

      // store data so the calendar knows to render an event upon drop
      $(this).data('event', {
        id: 'trailed',
        title: $.trim($(this).text()), // use the element's text as the event title
        constraint: 'available_for_booking',
        duration: '00:30',
        stick: true // maintain when user navigates (see docs on the renderEvent method),
      });

      // make the event draggable using jQuery UI
      $(this).draggable({
        zIndex: 999,
        revert: true,      // will cause the event to go back to its
        revertDuration: 0  //  original position after the drag
      });
    });
    i = 1;
    $('#external-events .nomal').each(function () {

      // store data so the calendar knows to render an event upon drop
      $(this).data('event', {
        id: 'nomal' + i,
        title: $.trim($(this).text()), // use the element's text as the event title
        constraint: 'available_for_booking',
        duration: '01:00',
        stick: true // maintain when user navigates (see docs on the renderEvent method),
      });

      // make the event draggable using jQuery UI
      $(this).draggable({
        zIndex: 999,
        revert: true,      // will cause the event to go back to its
        revertDuration: 0  //  original position after the drag
      });
      i++;
    });
    $('#calendar').fullCalendar({
      theme: true,
      //24小時制 大寫H
      minTime: '07:00:00',
      maxTime: '24:00:00',
      timeFormat: 'H:mm',
      allDaySlot: false,
      defaultDate: '<%=Time.now.strftime("%Y-%m-%d")%>',
      defaultView: 'agendaWeek',
      ignoreTimezone: false,
      droppable: true,
      drop: function (date, jsEvent, ui, resourceId) {
        s = $('#calendar').fullCalendar('clientEvents', $(this).data().event.id)[0];
        console.log($('#calendar').fullCalendar('clientEvents', $(this).data().event.id));
        if (!confirm("Are you sure to booking on " + s.start.format("YYYY-MM-DD HH:mm:ss") + '~' + s.end.format("YYYY-MM-DD HH:mm:ss") + "?")) {
          $('#calendar').fullCalendar('removeEvents', $(this).data().event.id);
        } else {
          $.ajax({
            url: '<%= appointments_url %>',
            data: {start: s.start.format("YYYY-MM-DD HH:mm:ss"), end: s.end.format("YYYY-MM-DD HH:mm:ss"), teacher_id: <%= @teacher.id %>},
            beforeSend: function (xhr) {
              xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
            },
            type: "POST",
            dataType: 'text',
            success: function (msg) {
//              console.log(msg);
//              var events = JSON.parse(msg);
//                eventData = {
//                  start: events.start,
//                  end: events.end,
//                  backgroundColor: 'blue',
//                  rendering: 'background',
//                };
//                $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true
              $('#calendar').fullCalendar('refetchEvents')
            },

            error: function (xhr, ajaxOptions, thrownError) {
              alert(xhr.status);
              alert(thrownError);
            }
          });
          $('#calendar').fullCalendar('refetchEvents');
          $('#calendar').fullCalendar('removeEvents', $(this).data().event.id);
          $(this).remove();
        }
      },
      eventLimit: true, // allow "more" link when too many events
      eventSources: [
        {
          //teacher events source
          url: 'http://localhost:3000/teacher_calendars/<%= @teacher.id %>/teacher_available_section.json', // use the `url` property
        }
      ]
    });

  });
</script>
<style>


  #wrap {
    width: 1100px;
    margin: 0 auto;
  }

  #external-events {
    float: left;
    width: 30%;
    padding: 0 10px;
    border: 1px solid #ccc;
    background: #eee;
    text-align: left;
  }

  #external-events h4 {
    font-size: 16px;
    margin-top: 0;
    padding-top: 1em;
  }

  #external-events .fc-event {
    margin: 10px 0;
    cursor: pointer;
  }

  #external-events .trailed {
    color: red;
  }

  #external-events .nomal {
    color: green;
  }

  #external-events p {
    margin: 1.5em 0;
    font-size: 11px;
    color: #666;
  }

  #external-events p input {
    margin: 0;
    vertical-align: middle;
  }

  #calendar {
    float: right;
    width: 900px;
  }

</style>
